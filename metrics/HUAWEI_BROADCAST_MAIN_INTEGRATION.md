# 华为云广播测试集成到main.py使用指南

## 概述

华为云广播测试功能已完全集成到main.py中，作为统一的测试入口。用户可以通过main.py运行华为云广播测试，包括广播发送和订阅测试的端到端验证。

## 功能特性

- ✅ 集成到main.py统一入口
- ✅ 支持华为云广播发送和订阅测试
- ✅ 用户提供所有必要参数
- ✅ 自动进程管理和清理
- ✅ 持续指标收集和报告生成
- ✅ 支持配置保存和加载

## 快速开始

### 1. 安装依赖

```bash
# 安装华为云SDK
pip3 install paho-mqtt huaweicloudsdkcore huaweicloudsdkiotda
```

### 2. 运行测试

```bash
# 进入metrics目录
cd metrics/

# 运行main.py
python3 main.py
```

### 3. 配置华为云参数

当选择华为云认证模式时，系统会提示输入以下参数：

#### 基础认证参数
- **设备ID前缀**: 华为云设备ID前缀（如：speaker）
- **设备密钥**: 华为云设备密钥

#### 广播测试参数
- **华为云访问密钥ID**: 华为云AK
- **华为云访问密钥Secret**: 华为云SK
- **华为云IoTDA端点**: 华为云IoTDA服务端点
- **华为云区域ID**: 华为云区域（默认：cn-north-4）
- **广播主题**: 广播消息主题（默认：$oc/broadcast/test）
- **广播发送间隔**: 广播发送间隔秒数（默认：5秒）

### 4. 选择测试类型

运行main.py后，选择测试类型：

```
请选择要运行的测试项:
  1. 运行所有测试
  2. 自定义选择测试项
  3. 快速测试（仅华为云连接测试）
  4. 华为云广播测试（发送+订阅）  ← 新增选项
```

## 测试流程

### 华为云广播测试流程

1. **启动广播发送器**
   - 使用华为云IoTDA SDK发送广播消息
   - 循环发送到指定主题（默认：$oc/broadcast/test）
   - 支持自定义发送间隔和持续时间

2. **启动订阅测试器**
   - 设备连接到华为云MQTT服务器
   - 订阅广播主题（$oc/broadcast/test）
   - 实时接收和解析广播消息

3. **端到端验证**
   - 验证设备能够接收到广播消息
   - 监控消息传输状态
   - 收集性能指标

4. **自动清理**
   - 测试完成后自动清理进程
   - 生成测试报告
   - 保存指标数据

## 配置说明

### 华为云参数配置

| 参数 | 说明 | 示例 |
|------|------|------|
| 设备ID前缀 | 华为云设备ID前缀 | speaker |
| 设备密钥 | 华为云设备密钥 | 12345678 |
| 华为云AK | 华为云访问密钥ID | AK... |
| 华为云SK | 华为云访问密钥Secret | SK... |
| 华为云端点 | 华为云IoTDA端点 | https://iotda.cn-north-4.myhuaweicloud.com |
| 华为云区域 | 华为云区域ID | cn-north-4 |
| 广播主题 | 广播消息主题 | $oc/broadcast/test |
| 广播间隔 | 广播发送间隔 | 5秒 |

### 测试参数配置

| 参数 | 说明 | 默认值 |
|------|------|--------|
| MQTT服务器 | 华为云MQTT服务器地址 | 自动配置 |
| MQTT端口 | 华为云MQTT端口 | 1883 |
| 客户端数量 | 同时连接的客户端数量 | 5 |
| 测试持续时间 | 每个测试的持续时间 | 60秒 |
| QoS等级 | MQTT消息质量等级 | 1 |

## 输出示例

### 配置显示
```
📋 当前配置内容:
┌─────────────────┬─────────────────────────────────────────┬──────────────────────────────────────────┐
│ 配置项          │ 值                                       │ 说明                                      │
├─────────────────┼─────────────────────────────────────────┼──────────────────────────────────────────┤
│ MQTT服务器      │ 016bc9ac7b.st1.iotda-device.cn-north-4. │ MQTT服务器地址和端口                      │
│                 │ myhuaweicloud.com:1883                   │                                          │
│ 客户端数量      │ 5                                        │ 同时连接的客户端数量                      │
│ 消息间隔        │ 1000ms                                  │ 消息发送间隔时间                          │
│ 测试持续时间    │ 60秒                                     │ 每个测试的持续时间                        │
│ Prometheus端口  │ 9090                                     │ Prometheus指标起始端口                    │
│ 华为云认证      │ 是                                       │ 是否使用华为云IoT认证                     │
│ 设备前缀        │ speaker                                 │ 华为云设备ID前缀                          │
│ 设备密钥        │ 12345678                                │ 华为云设备密钥                            │
│ 华为云AK        │ AK1234...                               │ 华为云访问密钥ID                          │
│ 华为云端点      │ https://iotda.cn-north-4.myhuaweicloud. │ 华为云IoTDA端点                          │
│                 │ com                                     │                                          │
│ 广播主题        │ $oc/broadcast/test                      │ 广播消息主题                              │
│ 广播间隔        │ 5秒                                     │ 广播发送间隔                              │
└─────────────────┴─────────────────────────────────────────┴──────────────────────────────────────────┘
```

### 测试执行
```
🚀 开始华为云广播测试...
📡 启动广播发送器...
✅ 广播发送器已启动 (PID: 12345)
📥 启动订阅测试...
✅ 订阅测试已启动 (PID: 12346)
🔍 启动 华为云广播测试 持续指标收集...
⏳ 等待测试完成 (60秒)...
⏹️ 停止 华为云广播测试 持续指标收集...
💾 已保存 华为云广播测试 持续指标数据: continuous_metrics_华为云广播测试_20241219_143022.json
🧹 清理测试进程...
✅ 进程 12345 已终止
✅ 进程 12346 已终止
✅ 华为云广播测试 测试完成
```

## 故障排除

### 常见问题

1. **华为云参数未配置**
   - 确保在配置时输入了所有必需的华为云参数
   - 检查AK/SK是否正确
   - 验证端点地址是否正确

2. **依赖包缺失**
   ```bash
   pip3 install paho-mqtt huaweicloudsdkcore huaweicloudsdkiotda
   ```

3. **进程启动失败**
   - 检查broadcast.py和huawei_subscribe_test.py是否存在
   - 确保Python环境正确
   - 检查文件权限

4. **网络连接问题**
   - 确保能够访问华为云IoTDA服务
   - 检查防火墙设置
   - 验证设备认证信息

### 调试模式

启用详细日志输出：

```bash
# 设置环境变量
export MQTT_LOG_LEVEL=DEBUG
python3 main.py
```

## 技术实现

### 核心组件

1. **main.py集成**
   - `_build_huawei_broadcast_test_command()`: 构建广播测试命令
   - `_execute_huawei_broadcast_test()`: 执行广播测试
   - `_start_broadcast_sender()`: 启动广播发送器
   - `_start_subscribe_test()`: 启动订阅测试
   - `_cleanup_process()`: 清理进程

2. **broadcast.py**
   - 支持从main.py调用
   - 接受命令行参数
   - 循环发送广播消息

3. **huawei_subscribe_test.py**
   - 订阅广播主题
   - 实时接收消息
   - 支持华为云认证

### 进程管理

- 自动启动广播发送器和订阅测试器
- 监控进程状态
- 测试完成后自动清理
- 支持优雅退出和强制终止

### 指标收集

- 持续收集性能指标
- 支持Prometheus格式
- 自动生成测试报告
- 保存历史数据

## 扩展功能

### 自定义配置

可以通过修改配置文件来自定义测试参数：

```json
{
  "huawei_ak": "your_ak",
  "huawei_sk": "your_sk",
  "huawei_endpoint": "your_endpoint",
  "broadcast_topic": "$oc/broadcast/custom",
  "broadcast_interval": 3
}
```

### 多设备测试

支持同时运行多个订阅测试器：

```bash
# 在多个终端中运行
python3 huawei_subscribe_test.py --device-prefix "device1" --device-secret "secret1"
python3 huawei_subscribe_test.py --device-prefix "device2" --device-secret "secret2"
```

## 最佳实践

1. **参数配置**
   - 使用强密码作为设备密钥
   - 定期轮换访问密钥
   - 确保端点地址正确

2. **测试环境**
   - 在测试环境中验证功能
   - 使用适当的测试数据
   - 监控系统资源使用

3. **错误处理**
   - 检查日志输出
   - 验证网络连接
   - 确认设备注册状态

---

**作者**: Jaxon  
**日期**: 2024-12-19  
**版本**: 1.0.0
